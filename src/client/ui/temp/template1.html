<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <!-- <meta http-equiv="Content-Security-Policy" content="default-src *; script-src * "> -->
  <link rel="stylesheet" href="./fonts/fa/css/all.min.css"/>
  <title>duneTest</title>
</head>
<body>
<div class="dunebody">

<!--   <div class="testclass error">
    <header>
      <span>Critical error</span>
      <div class="controls">
        <button class="system close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </header>
    <div class="body">
      <section class="top">
        <div class="error message">Something real bad happened.</div>
      </section>
      <section class="bottom">
        <div class="error-icon modal-icon"><img src="./assets/humanShit.png"/></div>
      </section>
    </div>
    <footer class="">
      <button class="popup red">OK</button>
    </footer>
  </div>

  <div class="testclass alert">
    <header class="">
      <span>Bad smell detected</span>
      <div class="controls">
        <button class="system close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </header>
    <div class="body">
      <section class="top">
        <div class="message alert">You smell funny.<br>Not funny like a clown, either.</div>
      </section>
      <section class="bottom">
        <div class="loading-spinner modal-icon"><img class="" src="./assets/doubleRing.svg"/></div>
      </section>
    </div>
    <footer class="">
      <button class="popup green">OK</button>
    </footer>
  </div>

  <div class="testclass query">
    <header class="">
      <span>Response required</span>
      <div class="controls">
        <button class="system close">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </header>
    <div class="body">
      <section class="top">
        <div class="query message">Would you like a wristy?</div>
      </section>
      <section class="bottom">
        <div class="modal-icon loading-spinner"><img src="./assets/doubleRing.svg"/></div>
      </section>
    </div>
    <footer class="">
      <button class="popup red">No</button>
      <button class="popup blue">Maybe</button>
      <button class="popup green">Yes</button>
    </footer>
  </div> -->

</div>
</body>

<script src="../TemplateEngine.mjs"></script>
<script src="../templates_dune.mjs"></script>
<script defer>

  const dragElement = (dragTarget, dragHandle, options={}) => {

    const target = typeof(dragTarget) === 'object' && dragTarget.tagName  ? dragTarget : document.querySelector(dragTarget),
      handle = dragHandle ? typeof(dragHandle) === 'object' && dragHandle.tagName ? dragHandle : document.querySelector(dragHandle) : target;

    let dragOptions = {
        bound: options.bound ?? true, // set to false to disable binding the draggabale element to the container
        boundingElement: options.boundingElement||document.documentElement,
        mouseButtons: options.mouseButtons||[1,2,3] // mouse buttons to allow for drag
    }
    let posXi = 0, posXf = 0, posYi = 0, posYf = 0;
    let minX, minY, maxX, maxY;
    let boundWidth, boundHeight;
    let finalLTRB = [null,null,null,null]; // left, top, right, bottom

    const getBounds = () => {
        boundWidth = dragOptions.boundingElement.clientWidth;
        boundHeight = dragOptions.boundingElement.clientHeight;        
        minX = 0, minY = 0, maxX = boundWidth - target.offsetWidth, maxY = boundHeight - target.offsetHeight;
        // console.info(minX, minY, maxX, maxY);
    }

    const elementGrab = (ev) => {
        // ev.preventDefault();
        if (dragOptions.bound) getBounds();
        posXi = ev.clientX;
        posYi = ev.clientY;
        document.addEventListener('mouseup', elementRelease);
        document.addEventListener('mousemove', elementDrag);
    }

    const elementDrag = (ev) => {
        // ev.preventDefault();
        target.dataset.dragging = true;
        posXf = posXi - ev.clientX;
        posYf = posYi - ev.clientY;
        posXi = ev.clientX;
        posYi = ev.clientY;

        finalLTRB[0] = dragOptions.bound ? Math.min(Math.max((target.offsetLeft - posXf), minX), maxX) : target.offsetLeft - posXf;
        finalLTRB[1] = dragOptions.bound ? Math.min(Math.max((target.offsetTop - posYf), minY), maxY) : target.offsetTop - posYf;


        Object.assign(target.style, { left: `${finalLTRB[0]}px`, top: `${finalLTRB[1]}px` });
    }

    const elementRelease = () => {
      document.removeEventListener('mousemove', elementDrag);
      document.removeEventListener('mouseup', elementRelease);
      setTimeout(() => {
        target.dataset.dragging = false;
      }, 500);
    }

    handle.addEventListener('mousedown', (ev) => {if (dragOptions.mouseButtons.includes(ev.which)) elementGrab(ev)});
  }

  const resolveSelector = (targetElementOrSelector) => {
  return typeof(targetElementOrSelector) === 'object' && targetElementOrSelector.tagName ? targetElementOrSelector
  : typeof(targetElementOrSelector) === 'string' ? document.querySelector(targetElementOrSelector)
  : null;
}

const getSiblingZindices = (targetElement, siblingFilter = '.fc-dune') => {
  const parent = typeof(targetElement) === 'object' && targetElement.tagName ? targetElement.parentNode
    : typeof(targetElement) === 'string' ? document.querySelector(targetElement)?.parentNode
    : null;
  if (!parent) {
    console.warn(`Invalid target element:`, targetElement);
    return [];
  }
  const siblings = siblingFilter ? parent.querySelectorAll(siblingFilter)
    : parent.childNodes || [];
  return Array.from(siblings).map(el => {
    const style = window.getComputedStyle(el);
    return parseInt(style.getPropertyValue('z-index')) || 0;
  });
}

const bringToFront = (targetElement) => {
  const target = resolveSelector(targetElement);
  if (!target) return console.warn(`No target element found for selector "${targetElement}"`);
  const zArray = getSiblingZindices(target);
  target.style['z-index'] = (Math.max(...zArray) || 0) + 1;
}

// document.querySelectorAll('div.testclass').forEach(el => {
//   dragElement(el, el.querySelector('header'));
//   el.addEventListener('mousedown', () => bringToFront(el));
// });

const TE = new TemplateEngine(templates);

const newFrame = (frameData={}, container = '.dunebody') => {
  const frame = TE.create(frameData),
    target = document.querySelector(container) ?? document.body;
  target.append(frame);
  dragElement(frame, frame.querySelector('header'));
  frame.addEventListener('mousedown', () => bringToFront(frame));
  return frame.id;
}

const newBlockingFrame = async (frameData={}, container = '.dunebody') => {
  return new Promise(res => {
    frameData.messageTop = `<select name="house"><option value="atreides">Atreides</option><option value="harkonnen">Harkonnen</option></select>`;
    const frame = TE.create(frameData),
      target = document.querySelector(container) ?? document.body;
    target.append(frame);
    dragElement(frame, frame.querySelector('header'));
    frame.addEventListener('mousedown', () => bringToFront(frame));
    // return frame.id;
    const returnDataHandler = (ev) => {
      if (ev.detail.id === frame.id) {
        console.log(`correct id found`);
        res(ev.detail);
        target.removeEventListener('returnModalData', returnDataHandler);
      }
    }
    target.addEventListener('returnModalData', returnDataHandler);
  });
}

</script>
</html>